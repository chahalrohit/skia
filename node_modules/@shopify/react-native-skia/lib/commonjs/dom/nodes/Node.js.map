{"version":3,"names":["JsiNode","constructor","ctx","type","props","Skia","depMgr","setProps","setProp","name","v","hasChanged","getProps","children","_children","addChild","child","push","dispose","unsubscribeNode","forEach","removeChild","index","indexOf","node","splice","insertChildBefore","before","beforeIndex","JsiDeclarationNode","declarationType","Error","invalidate","setInvalidate","isPaint","DeclarationType","Paint","isImageFilter","ImageFilter","isColorFilter","ColorFilter","isShader","Shader","isMaskFilter","MaskFilter","isPathEffect","PathEffect"],"sources":["Node.ts"],"sourcesContent":["import type {\n  SkColorFilter,\n  Skia,\n  SkImageFilter,\n  SkMaskFilter,\n  SkShader,\n  SkPathEffect,\n  SkPaint,\n} from \"../../skia/types\";\nimport type { Node, DeclarationNode, NodeType } from \"../types\";\nimport { DeclarationType } from \"../types\";\nimport type { DependencyManager } from \"../../renderer/DependencyManager\";\n\nexport interface NodeContext {\n  Skia: Skia;\n  depMgr: DependencyManager;\n}\n\nexport abstract class JsiNode<P> implements Node<P> {\n  protected _children: JsiNode<unknown>[] = [];\n  protected Skia: Skia;\n  protected depMgr: DependencyManager;\n\n  constructor(ctx: NodeContext, public type: NodeType, protected props: P) {\n    this.Skia = ctx.Skia;\n    this.depMgr = ctx.depMgr;\n  }\n\n  setProps(props: P) {\n    this.props = props;\n  }\n\n  setProp<K extends keyof P>(name: K, v: P[K]) {\n    const hasChanged = this.props[name] !== v;\n    this.props[name] = v;\n    return hasChanged;\n  }\n\n  getProps() {\n    return this.props;\n  }\n\n  children() {\n    return this._children;\n  }\n\n  addChild(child: Node<unknown>) {\n    this._children.push(child as JsiNode<unknown>);\n  }\n\n  dispose() {\n    this.depMgr.unsubscribeNode(this);\n    this._children.forEach((child) => child.dispose());\n  }\n\n  removeChild(child: Node<unknown>) {\n    const index = this._children.indexOf(child as JsiNode<unknown>);\n    if (index !== -1) {\n      const [node] = this._children.splice(index, 1);\n      node.dispose();\n    }\n  }\n\n  insertChildBefore(child: Node<unknown>, before: Node<unknown>) {\n    const index = this._children.indexOf(child as JsiNode<unknown>);\n    if (index !== -1) {\n      this._children.splice(index, 1);\n    }\n    const beforeIndex = this._children.indexOf(before as JsiNode<unknown>);\n    this._children.splice(beforeIndex, 0, child as JsiNode<unknown>);\n  }\n}\n\nexport type Invalidate = () => void;\n\nexport abstract class JsiDeclarationNode<\n    P,\n    T,\n    Nullable extends null | never = never\n  >\n  extends JsiNode<P>\n  implements DeclarationNode<P, T, Nullable>\n{\n  private invalidate: Invalidate = () => {};\n\n  constructor(\n    ctx: NodeContext,\n    public declarationType: DeclarationType,\n    type: NodeType,\n    props: P\n  ) {\n    super(ctx, type, props);\n  }\n\n  abstract materialize(): T | Nullable;\n\n  addChild(child: Node<unknown>): void {\n    if (!(child instanceof JsiDeclarationNode)) {\n      throw new Error(`Cannot add child of type ${child.type} to ${this.type}`);\n    }\n    super.addChild(child);\n    this.invalidate();\n  }\n\n  insertChildBefore(child: Node<unknown>, before: Node<unknown>): void {\n    if (!(child instanceof JsiDeclarationNode)) {\n      throw new Error(`Cannot add child of type ${child.type} to ${this.type}`);\n    }\n    super.insertChildBefore(child, before);\n    this.invalidate();\n  }\n\n  dispose() {\n    this.invalidate();\n    super.dispose();\n  }\n\n  setInvalidate(invalidate: Invalidate) {\n    this.invalidate = invalidate;\n  }\n\n  setProps(props: P) {\n    super.setProps(props);\n    this.invalidate();\n  }\n\n  setProp<K extends keyof P>(name: K, v: P[K]) {\n    const hasChanged = super.setProp(name, v);\n    if (hasChanged) {\n      this.invalidate();\n    }\n    return hasChanged;\n  }\n\n  isPaint(): this is DeclarationNode<unknown, SkPaint> {\n    return this.declarationType === DeclarationType.Paint;\n  }\n\n  isImageFilter(): this is DeclarationNode<unknown, SkImageFilter> {\n    return this.declarationType === DeclarationType.ImageFilter;\n  }\n\n  isColorFilter(): this is DeclarationNode<unknown, SkColorFilter> {\n    return this.declarationType === DeclarationType.ColorFilter;\n  }\n\n  isShader(): this is DeclarationNode<unknown, SkShader> {\n    return this.declarationType === DeclarationType.Shader;\n  }\n\n  isMaskFilter(): this is DeclarationNode<unknown, SkMaskFilter> {\n    return this.declarationType === DeclarationType.MaskFilter;\n  }\n\n  isPathEffect(): this is DeclarationNode<unknown, SkPathEffect> {\n    return this.declarationType === DeclarationType.PathEffect;\n  }\n}\n"],"mappings":"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"}